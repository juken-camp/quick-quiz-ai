<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Quick Quiz AI</title>
    <script src="problems.js" onerror="console.log('problems.js not found, using empty DB')"></script>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        :root{
            --bk:#0d0d0f;--dk:#1c1c22;--mid:#6b6b7a;--soft:#9999aa;
            --ln:#e4e4ec;--ft:#f4f4f8;--wh:#ffffff;
            --ac:#6c63ff;--ac2:#9d97ff;--ac-bg:#f0efff;
            --grn:#00c97a;--grn-bg:#e6faf3;--red:#ff4757;--red-bg:#fff1f2;
            --fd:'Syne',sans-serif;--fb:'Noto Sans JP',sans-serif;--fm:'DM Mono',monospace;
            --glow:0 0 24px rgba(108,99,255,.18);
            --shadow-sm:0 2px 8px rgba(13,13,15,.08);
            --shadow-md:0 8px 32px rgba(13,13,15,.12);
        }
        body{font-family:var(--fb);background:#f7f7fb;color:var(--bk);min-height:100vh;
            -webkit-user-select:none;user-select:none;touch-action:manipulation;overflow-x:hidden;
            -webkit-tap-highlight-color:transparent}

        .shell{max-width:480px;margin:0 auto;padding:0 18px;min-height:100vh}
        .header{padding:24px 0 8px;position:relative}
        .header-logo{font-family:var(--fd);font-weight:800;font-size:26px;letter-spacing:-.04em;line-height:1;display:flex;align-items:center;gap:8px}
        .header-logo .ai{display:inline-flex;align-items:center;justify-content:center;
            background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);
            font-size:9px;font-weight:700;letter-spacing:.12em;padding:3px 8px;border-radius:5px;
            box-shadow:var(--glow);position:relative;top:-1px}
        .header-sub{font-family:var(--fm);font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--soft);margin-top:5px}
        .header-line{width:100%;height:1px;background:linear-gradient(90deg,var(--ac) 0%,var(--ln) 60%);margin-top:12px;opacity:.6}

        .screen{animation:si .4s cubic-bezier(.22,1,.36,1)}
        @keyframes si{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
        .hidden{display:none!important}

        .label{font-family:var(--fm);font-size:10px;font-weight:500;letter-spacing:.18em;text-transform:uppercase;color:var(--soft);margin-bottom:10px}
        .label-lg{font-family:var(--fd);font-size:18px;font-weight:700;letter-spacing:-.02em;margin-bottom:4px}
        .label-desc{font-size:12px;color:var(--mid);line-height:1.5;margin-bottom:14px}

        /* Subject list */
        .subj-grid{display:flex;flex-direction:column;gap:6px}
        .subj-item{display:flex;align-items:center;gap:12px;padding:12px 14px;
            border-radius:12px;background:var(--wh);box-shadow:var(--shadow-sm);
            border:1.5px solid transparent;
            cursor:pointer;transition:all .2s cubic-bezier(.22,1,.36,1);
            width:100%;text-align:left;font-family:var(--fb);color:var(--bk)}
        @media(hover:hover){
            .subj-item:hover{border-color:var(--ac);box-shadow:var(--glow),var(--shadow-md);transform:translateY(-1px)}
            .subj-item:hover .subj-icon{background:linear-gradient(135deg,var(--ac),var(--ac2))}
            .subj-item:hover .subj-icon span{filter:brightness(10) saturate(0)}
            .subj-item:hover .subj-arrow{transform:translateX(3px);color:var(--ac)}
        }
        .subj-item:active{transform:translateY(0);opacity:.85}
        .subj-item:focus,.subj-item:focus-visible{outline:none;border-color:transparent}
        button:focus{outline:none} button:focus-visible{outline:2px solid var(--ac);outline-offset:2px}
        .subj-item:focus:not(:focus-visible){border-color:transparent;box-shadow:var(--shadow-sm);transform:none}
        .subj-icon{width:38px;height:38px;border-radius:10px;
            background:linear-gradient(135deg,var(--ac-bg),var(--ft));
            display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;transition:all .2s}
        .subj-text{font-weight:600;font-size:14px;letter-spacing:-.01em}
        .subj-arrow{margin-left:auto;font-size:14px;color:var(--soft);transition:all .2s}

        /* Overlay */
        .overlay{display:none;position:fixed;inset:0;background:rgba(247,247,251,.96);backdrop-filter:blur(24px);
            -webkit-backdrop-filter:blur(24px);z-index:310;overflow-y:auto}
        .overlay.show{display:block;animation:fi .2s ease}
        @keyframes fi{from{opacity:0}to{opacity:1}}
        .overlay-inner{max-width:480px;margin:0 auto;padding:28px 18px 80px;animation:su .3s cubic-bezier(.22,1,.36,1)}
        @keyframes su{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

        /* Category list */
        .cat-list{display:flex;flex-direction:column;gap:3px}
        .cat-item{display:flex;align-items:center;padding:10px 11px;border-radius:9px;
            border:1.5px solid transparent;background:var(--wh);
            cursor:pointer;font-family:var(--fb);font-size:13px;font-weight:500;color:var(--dk);transition:all .15s}
        @media(hover:hover){.cat-item:hover{background:var(--ac-bg);border-color:var(--ac2)}}
        .cat-item::before{content:'';width:16px;height:16px;border:2px solid var(--ln);border-radius:4px;
            margin-right:11px;flex-shrink:0;transition:all .15s}
        .cat-item.active::before{background:var(--ac);border-color:var(--ac);box-shadow:inset 0 0 0 2px var(--wh)}
        .cat-item.active{color:var(--bk);font-weight:600;background:var(--ac-bg);border-color:var(--ac2)}
        .grade-div{font-family:var(--fm);font-size:9px;font-weight:500;letter-spacing:.2em;text-transform:uppercase;color:var(--soft);padding:12px 0 4px}

        /* Buttons */
        .btn{font-family:var(--fd);font-weight:700;font-size:13px;letter-spacing:.02em;padding:12px 28px;border:none;border-radius:11px;cursor:pointer;transition:all .2s}
        .btn-bk{background:linear-gradient(135deg,var(--bk),#2d2d3a);color:var(--wh);box-shadow:var(--shadow-md)}
        @media(hover:hover){.btn-bk:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(13,13,15,.2)}}
        .btn-bk:disabled{background:var(--ln);color:var(--soft);cursor:default;transform:none;box-shadow:none}
        .btn-ol{background:transparent;color:var(--mid);border:1.5px solid var(--ln);border-radius:11px}
        @media(hover:hover){.btn-ol:hover{border-color:var(--ac);color:var(--ac)}}
        .btn-full{width:100%}
        .back-link{font-family:var(--fm);font-size:11px;letter-spacing:.1em;color:var(--soft);cursor:pointer;background:none;border:none;padding:10px 0;transition:color .15s}
        @media(hover:hover){.back-link:hover{color:var(--ac)}}

        /* Stats */
        .stats-row{display:grid;grid-template-columns:repeat(3,1fr);background:var(--wh);border:1.5px solid var(--ln);border-radius:14px;overflow:hidden;margin:14px 0;box-shadow:var(--shadow-sm)}
        .stat-cell{padding:12px 8px;text-align:center;border-right:1px solid var(--ln)}
        .stat-cell:last-child{border-right:none}
        .stat-num{font-family:var(--fd);font-size:24px;font-weight:800;letter-spacing:-.03em}
        .stat-label{font-family:var(--fm);font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--soft);margin-top:3px}

        /* Mode (quiz mode toggle) */
        .mode-row{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin:12px 0}
        .mode-btn{background:var(--wh);border:1.5px solid var(--ln);border-radius:9px;padding:10px;font-family:var(--fb);
            font-size:12px;font-weight:500;color:var(--mid);cursor:pointer;transition:all .15s;text-align:center;box-shadow:var(--shadow-sm)}
        .mode-btn.active{background:var(--ac-bg);border-color:var(--ac);color:var(--ac);font-weight:700}

        /* Quiz overlay */
        .quiz-ov{display:none;position:fixed;inset:0;background:#f7f7fb;z-index:200;overflow-y:auto}
        .quiz-ov.show{display:block;animation:fi .2s ease}
        .quiz-in{max-width:480px;margin:0 auto;padding:20px 16px 80px;animation:su .3s cubic-bezier(.22,1,.36,1)}
        .quiz-cnt{font-family:var(--fm);font-size:10px;letter-spacing:.15em;text-transform:uppercase;color:var(--ac);margin-bottom:10px;
            display:flex;align-items:center;gap:6px}
        .quiz-cnt::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--ac);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
        .quiz-q{font-family:var(--fd);font-size:17px;font-weight:700;letter-spacing:-.02em;line-height:1.45;margin-bottom:14px}
        .quiz-opts{display:flex;flex-direction:column;gap:7px}
        .quiz-opt{display:flex;align-items:center;gap:10px;padding:11px 14px;
            border:1.5px solid var(--ln);border-radius:12px;background:var(--wh);
            cursor:pointer;font-family:var(--fb);font-size:14px;font-weight:500;color:var(--dk);
            transition:all .18s cubic-bezier(.22,1,.36,1);width:100%;text-align:left;
            box-shadow:var(--shadow-sm)}
        @media(hover:hover){
            .quiz-opt:hover{border-color:var(--ac);box-shadow:var(--glow),var(--shadow-md);transform:translateX(4px)}
            .quiz-opt:hover .quiz-let{background:var(--ac);color:var(--wh)}
        }
        .quiz-opt:active{transform:translateX(2px);opacity:.85}
        .quiz-let{width:26px;height:26px;border-radius:7px;background:var(--ft);display:flex;align-items:center;
            justify-content:center;font-family:var(--fm);font-size:11px;font-weight:500;color:var(--mid);flex-shrink:0;transition:all .18s}
        .quiz-res{margin-top:12px;padding:12px 16px;border-radius:12px;font-size:13px;line-height:1.6;font-weight:500;
            border:1.5px solid transparent;background:transparent;color:var(--mid);min-height:0;transition:all .3s}
        .quiz-res.ok{border-color:var(--grn);background:var(--grn-bg);color:#0a6644;
            box-shadow:0 4px 20px rgba(0,201,122,.12)}
        .quiz-res.ng{border-color:var(--red);background:var(--red-bg);color:#9b1625;
            box-shadow:0 4px 20px rgba(255,71,87,.12)}
        .quiz-acts{display:flex;gap:8px;margin-top:12px}
        .quiz-acts .btn{flex:1;text-align:center;padding:11px 16px;font-size:13px}

        /* ===== AIå…ˆç”Ÿãƒãƒ¼ï¼ˆå›ºå®š1è¡Œï¼‰ ===== */
        .ai-bar{position:fixed;bottom:0;left:0;right:0;z-index:500;
            background:rgba(255,255,255,.96);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
            border-top:1.5px solid rgba(108,99,255,.2);
            box-shadow:0 -2px 20px rgba(108,99,255,.1);
            display:flex!important;align-items:center;gap:8px;padding:8px 14px 12px;
            padding-bottom:max(12px,env(safe-area-inset-bottom))}
        .ai-bar-label{font-family:var(--fd);font-size:12px;font-weight:700;color:var(--ac);
            white-space:nowrap;display:flex;align-items:center;gap:5px}
        .ai-bar-label::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--ac);
            box-shadow:0 0 6px var(--ac);animation:pulse 2s infinite;flex-shrink:0}
        .ai-bar-input{flex:1;background:var(--ft);border:1.5px solid var(--ln);border-radius:20px;
            padding:7px 13px;font-size:13px;font-family:var(--fb);color:var(--bk);outline:none;transition:all .2s;min-width:0}
        .ai-bar-input:focus{border-color:var(--ac);background:var(--wh);box-shadow:0 0 0 3px rgba(108,99,255,.1)}
        .ai-bar-input::placeholder{color:var(--soft)}
        .ai-bar-btn{width:34px;height:34px;border-radius:50%;border:none;cursor:pointer;
            display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;transition:all .15s}
        .ai-bar-send{background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);box-shadow:var(--glow)}
        @media(hover:hover){.ai-bar-send:hover{transform:scale(1.08)}}.ai-bar-send:disabled{background:var(--ln);box-shadow:none}
        .ai-bar-icon{background:var(--ft);color:var(--mid);border:1.5px solid var(--ln)}
        @media(hover:hover){.ai-bar-icon:hover{border-color:var(--ac);color:var(--ac);background:var(--ac-bg)}}

        /* ===== ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ ===== */
        .typing{display:flex;gap:4px;align-items:center;height:16px}
        .typing span{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.4;
            animation:typingDot 1.2s infinite ease-in-out}
        .typing span:nth-child(2){animation-delay:.2s}
        .typing span:nth-child(3){animation-delay:.4s}
        @keyframes typingDot{0%,80%,100%{opacity:.4;transform:scale(1)}40%{opacity:1;transform:scale(1.2)}}

        /* ===== æµ®éŠãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ–ãƒ« ===== */
        .float-bubble{position:fixed;right:16px;z-index:290;
            max-width:min(480px,calc(100vw - 32px));padding:10px 18px 10px 14px;border-radius:18px;
            font-size:13px;line-height:1.6;font-family:var(--fb);
            pointer-events:auto;text-align:left;cursor:pointer;
            animation:bubbleFloat var(--bubble-duration,10s) cubic-bezier(.22,1,.36,1) forwards}
        @media(hover:hover){.float-bubble:hover{filter:brightness(.95);transform-origin:right bottom}}
        .float-bubble::after{content:"âœ•";position:absolute;top:6px;right:9px;
            font-size:9px;color:var(--mid);opacity:0;transition:opacity .15s;font-family:var(--fm)}
        @media(hover:hover){.float-bubble:hover::after{opacity:0.45}}
        .float-bubble:active::after{opacity:0.45}
        .float-bubble.ai{background:rgba(240,239,255,.92);backdrop-filter:blur(8px);
            border:1px solid rgba(108,99,255,.2);color:var(--dk);
            box-shadow:0 4px 20px rgba(108,99,255,.12)}
        .float-bubble.ai.ok{background:rgba(230,250,243,.92);border-color:rgba(0,201,122,.25);color:#0a5c3a}
        .float-bubble.ai.ng{background:rgba(255,241,242,.92);border-color:rgba(255,71,87,.2);color:#8b1a26}
        .float-bubble.user{background:rgba(108,99,255,.88);color:var(--wh);
            box-shadow:0 4px 20px rgba(108,99,255,.25)}
        .float-bubble p{margin:0 0 8px}
        .float-bubble p:last-child{margin-bottom:0}
        @keyframes bubbleIn{
            0%  {opacity:0;transform:translateY(8px) scale(.96);transform-origin:right bottom}
            100%{opacity:1;transform:translateY(0) scale(1)}}
        @keyframes bubbleFloat{
            0%  {opacity:0;bottom:100px;transform:translateY(10px) scale(.95);transform-origin:right bottom}
            12% {opacity:1;transform:translateY(0) scale(1)}
            75% {opacity:1}
            100%{opacity:0;bottom:220px;transform:scale(1)}}

        /* ===== è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
        .setting-ov{display:none;position:fixed;inset:0;z-index:600;
            background:rgba(13,13,15,.4);backdrop-filter:blur(8px);align-items:flex-end;justify-content:center}
        .setting-ov.show{display:flex;animation:fi .2s}
        .setting-box{background:var(--wh);border-radius:24px 24px 0 0;width:100%;max-width:480px;
            padding:20px 20px 36px;animation:su .3s cubic-bezier(.22,1,.36,1)}
        .setting-title{font-family:var(--fd);font-weight:700;font-size:16px;margin-bottom:16px;
            display:flex;align-items:center;justify-content:space-between}
        .setting-close{background:var(--ft);border:none;border-radius:50%;width:28px;height:28px;
            font-size:14px;cursor:pointer;color:var(--mid);display:flex;align-items:center;justify-content:center}
        .mode-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .mode-row-toggle{justify-content:space-between}
        .mode-label{font-family:var(--fm);font-size:9px;letter-spacing:.12em;text-transform:uppercase;
            color:var(--soft);white-space:nowrap;min-width:40px}
        .mode-btns{display:flex;gap:6px;flex-wrap:wrap}
        .mode-btn{font-size:12px;font-family:var(--fb);font-weight:500;padding:6px 14px;
            border:1.5px solid var(--ln);border-radius:20px;background:var(--wh);
            color:var(--mid);cursor:pointer;transition:all .15s;white-space:nowrap}
        @media(hover:hover){.mode-btn:hover{border-color:var(--ac2);color:var(--ac)}}
        .mode-btn.mode-active{background:var(--ac);color:var(--wh);border-color:var(--ac);box-shadow:var(--glow)}
        .toggle-wrap{position:relative;display:inline-block;width:40px;height:22px;flex-shrink:0}
        .toggle-wrap input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;inset:0;background:var(--ln);border-radius:22px;cursor:pointer;transition:background .2s}
        .toggle-slider::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;
            background:var(--wh);border-radius:50%;transition:transform .2s;box-shadow:var(--shadow-sm)}
        .toggle-wrap input:checked+.toggle-slider{background:var(--ac);box-shadow:var(--glow)}
        .toggle-wrap input:checked+.toggle-slider::before{transform:translateX(18px)}

        /* ===== å±¥æ­´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
        .hist-ov{display:none;position:fixed;inset:0;z-index:600;
            background:rgba(13,13,15,.5);backdrop-filter:blur(10px);align-items:flex-end;justify-content:center}
        .hist-ov.show{display:flex;animation:fi .2s}
        .hist-box{background:var(--wh);border-radius:24px 24px 0 0;width:100%;max-width:480px;
            height:70vh;display:flex;flex-direction:column;animation:su .3s cubic-bezier(.22,1,.36,1)}
        .hist-hd{display:flex;align-items:center;justify-content:space-between;
            padding:16px 20px 12px;border-bottom:1px solid var(--ln);flex-shrink:0}
        .hist-title{font-family:var(--fd);font-weight:700;font-size:15px}
        .hist-close{background:var(--ft);border:none;border-radius:50%;width:28px;height:28px;
            font-size:14px;cursor:pointer;color:var(--mid);display:flex;align-items:center;justify-content:center}
        .hist-list{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px}
        .hist-m{max-width:86%;padding:8px 13px;font-size:13px;line-height:1.6;border-radius:14px;word-break:break-word}
        .hist-m.u{background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);
            align-self:flex-end;border-bottom-right-radius:3px}
        .hist-m.a{background:var(--ft);color:var(--dk);align-self:flex-start;
            border-bottom-left-radius:3px;border:1px solid var(--ln)}
        .hist-m.a strong{color:var(--ac)}.hist-m.a p{margin:3px 0}
        .hist-m.a ul,.hist-m.a ol{padding-left:15px;margin:3px 0}
        .hist-chips{display:flex;flex-wrap:wrap;gap:5px;padding:8px 16px;border-top:1px solid var(--ln);flex-shrink:0}
        .chip{background:var(--wh);border:1.5px solid var(--ln);border-radius:20px;padding:5px 12px;
            font-size:11px;font-weight:500;color:var(--dk);cursor:pointer;transition:all .15s;white-space:nowrap}
        @media(hover:hover){.chip:hover{border-color:var(--ac);color:var(--ac);background:var(--ac-bg)}}
        .hist-empty{color:var(--soft);font-size:13px;text-align:center;padding:40px 0}

        /* ===== ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒƒãƒ— ===== */
        .quick-chips{position:fixed;bottom:56px;left:0;right:0;z-index:495;
            display:flex;gap:6px;padding:6px 12px;overflow-x:auto;
            scrollbar-width:none;-ms-overflow-style:none;
            pointer-events:none;opacity:0;transform:translateY(6px);
            transition:opacity .25s,transform .25s}
        .quick-chips::-webkit-scrollbar{display:none}
        .quick-chips.visible{opacity:1;transform:translateY(0);pointer-events:auto}
        .qchip{flex-shrink:0;height:30px;padding:0 13px;border-radius:15px;border:1.5px solid rgba(108,99,255,.3);
            background:rgba(255,255,255,.88);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
            font-family:var(--fb);font-size:12px;font-weight:500;color:var(--ac);
            cursor:pointer;white-space:nowrap;transition:all .15s;
            box-shadow:0 2px 10px rgba(108,99,255,.1)}
        @media(hover:hover){.qchip:hover{background:var(--ac);color:var(--wh);border-color:var(--ac);transform:translateY(-1px)}}
        .qchip:active{transform:translateY(0);opacity:.8}

        /* ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ä½™ç™½ï¼ˆAIãƒãƒ¼åˆ†ï¼‰ */
        .ai-bar-spacer{height:68px}

        /* FABs */
        .fab-row{position:fixed;bottom:68px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:150;white-space:nowrap;animation:fi .3s}
        .fab{height:44px;border-radius:22px;border:none;font-family:var(--fd);font-weight:700;font-size:13px;
            cursor:pointer;display:flex;align-items:center;gap:8px;padding:0 20px;transition:all .2s;box-shadow:var(--shadow-md);white-space:nowrap;flex-shrink:0}
        @media(hover:hover){.fab:hover{transform:translateY(-3px)}}
        .fab-dk{background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);box-shadow:var(--glow),var(--shadow-md)}
        .fab-lt{background:var(--wh);color:var(--bk);border:1.5px solid var(--ln)}
        @media(hover:hover){.fab-lt:hover{border-color:var(--ac);color:var(--ac)}}

        /* Toast */
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);
            background:linear-gradient(135deg,var(--ac),var(--ac2));color:var(--wh);
            padding:12px 24px;border-radius:50px;font-size:13px;font-weight:600;z-index:400;
            transition:transform .3s cubic-bezier(.22,1,.36,1);white-space:nowrap;box-shadow:var(--glow)}
        .toast.show{transform:translateX(-50%) translateY(0)}

        .spacer{height:80px}

        /* æˆç¸¾ãƒˆãƒ©ãƒƒã‚«ãƒ¼ */
        .tracker-section{margin-top:14px;background:var(--wh);border-radius:14px;padding:14px 14px 10px;box-shadow:var(--shadow-sm);border:1.5px solid var(--ln)}
        .tracker-title{font-family:var(--fd);font-weight:700;font-size:13px;letter-spacing:-.01em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
        .tracker-item{display:flex;align-items:center;gap:10px;padding:8px 10px;margin:0 -10px;border-radius:10px;
            border-bottom:1px solid var(--ft);cursor:pointer;transition:all .15s;border:1.5px solid transparent}
        .tracker-item:last-of-type{border-bottom-color:transparent}
        @media(hover:hover){.tracker-item:hover{background:var(--ac-bg);border-color:var(--ac2)}}
        .tracker-item:active{opacity:.8;transform:scale(.98)}
        .tracker-rank{font-size:18px;flex-shrink:0}
        .tracker-info{flex:1;min-width:0}
        .tracker-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:5px}
        .tracker-bar-wrap{background:var(--ft);border-radius:4px;height:5px;overflow:hidden}
        .tracker-bar{height:100%;border-radius:4px;transition:width .6s cubic-bezier(.22,1,.36,1)}
        .tracker-bar.weak{background:linear-gradient(90deg,var(--red),#ff8a93)}
        .tracker-bar.strong{background:linear-gradient(90deg,var(--grn),#5ae4a7)}
        .tracker-pct{font-family:var(--fm);font-size:11px;font-weight:600;text-align:center;flex-shrink:0;line-height:1.3}
        .tracker-pct.weak{color:var(--red)}
        .tracker-pct.strong{color:var(--grn)}
        .tracker-pct small{font-size:9px;color:var(--mid);font-weight:400}
        .tracker-arrow{font-size:12px;color:var(--soft);flex-shrink:0;transition:all .15s}
        @media(hover:hover){.tracker-item:hover .tracker-arrow{color:var(--ac);transform:translateX(2px)}}
        .tracker-empty{font-size:12px;color:var(--soft);padding:4px 0 8px}
        .tracker-footer{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
        .tracker-reset-btn{font-size:10px;font-family:var(--fm);letter-spacing:.1em;color:var(--soft);background:none;border:none;cursor:pointer;padding:0}
        @media(hover:hover){.tracker-reset-btn:hover{color:var(--red)}}
        .tracker-detail-btn{font-size:11px;font-family:var(--fb);font-weight:600;color:var(--ac);
            background:var(--ac-bg);border:1px solid rgba(108,99,255,.15);border-radius:16px;padding:4px 12px;cursor:pointer;transition:all .15s}
        @media(hover:hover){.tracker-detail-btn:hover{background:var(--ac);color:var(--wh)}}
        .tracker-detail-btn:active{transform:scale(.95)}

        /* ===== æˆç¸¾è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
        .stats-detail-ov{display:none;position:fixed;inset:0;z-index:600;
            background:rgba(13,13,15,.4);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
            align-items:flex-end;justify-content:center}
        .stats-detail-ov.show{display:flex;animation:fi .2s}
        .stats-detail-box{background:var(--wh);border-radius:24px 24px 0 0;width:100%;max-width:480px;
            max-height:85vh;display:flex;flex-direction:column;animation:su .3s cubic-bezier(.22,1,.36,1)}
        .stats-detail-hd{display:flex;align-items:center;justify-content:space-between;
            padding:16px 20px 12px;border-bottom:1px solid var(--ln);flex-shrink:0}
        .stats-detail-title{font-family:var(--fd);font-weight:700;font-size:15px}
        .stats-detail-close{background:var(--ft);border:none;border-radius:50%;width:28px;height:28px;
            font-size:14px;cursor:pointer;color:var(--mid);display:flex;align-items:center;justify-content:center}
        .stats-detail-body{flex:1;overflow-y:auto;padding:16px 20px 28px}
        .stats-detail-section{margin-bottom:20px}
        .stats-detail-section-title{font-family:var(--fd);font-weight:700;font-size:13px;letter-spacing:-.01em;
            margin-bottom:8px;display:flex;align-items:center;gap:6px;padding-bottom:6px;border-bottom:1px solid var(--ft)}
        .stats-detail-list{display:flex;flex-direction:column;gap:2px}
        .stats-summary-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:16px}
        .stats-summary-card{background:var(--ft);border-radius:12px;padding:10px 8px;text-align:center}
        .stats-summary-num{font-family:var(--fd);font-size:22px;font-weight:800;letter-spacing:-.03em}
        .stats-summary-label{font-family:var(--fm);font-size:8px;letter-spacing:.12em;text-transform:uppercase;color:var(--soft);margin-top:2px}

        /* ===== ã‚¿ã‚¤ãƒãƒ¼ & å‘¨å›è¨­å®š ===== */
        .setting-card{background:var(--wh);border:1.5px solid var(--ln);border-radius:14px;padding:14px;margin-top:12px;box-shadow:var(--shadow-sm)}
        .setting-card-title{font-family:var(--fd);font-weight:700;font-size:13px;letter-spacing:-.01em;margin-bottom:10px;display:flex;align-items:center;gap:6px}
        .timer-grid{display:grid;grid-template-columns:1fr 12px 1fr;gap:0;align-items:center}
        .timer-input-wrap{display:flex;flex-direction:column;align-items:center;gap:2px}
        .timer-input-label{font-family:var(--fm);font-size:8px;letter-spacing:.15em;text-transform:uppercase;color:var(--soft)}
        .timer-input{width:100%;text-align:center;font-family:var(--fm);font-size:22px;font-weight:600;
            background:var(--ft);border:1.5px solid var(--ln);border-radius:10px;padding:8px 4px;
            color:var(--bk);outline:none;transition:all .2s;-moz-appearance:textfield}
        .timer-input::-webkit-outer-spin-button,.timer-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
        .timer-input:focus{border-color:var(--ac);box-shadow:0 0 0 3px rgba(108,99,255,.1)}
        .timer-colon{font-family:var(--fm);font-size:22px;font-weight:700;color:var(--mid);text-align:center;padding-top:14px}
        .timer-presets{display:flex;gap:5px;margin-top:8px;flex-wrap:wrap}
        .timer-preset{font-family:var(--fm);font-size:10px;font-weight:500;padding:4px 10px;
            border:1.5px solid var(--ln);border-radius:16px;background:var(--wh);
            color:var(--mid);cursor:pointer;transition:all .15s;white-space:nowrap}
        .timer-preset.active{background:var(--ac);color:var(--wh);border-color:var(--ac);box-shadow:var(--glow)}
        @media(hover:hover){.timer-preset:hover{border-color:var(--ac2);color:var(--ac)}}
        .timer-toggle-row{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
        .timer-toggle-label{font-size:12px;color:var(--mid);font-weight:500}

        .lap-row{display:flex;align-items:center;gap:8px;margin-top:4px}
        .lap-btn{width:34px;height:34px;border-radius:50%;border:1.5px solid var(--ln);background:var(--wh);
            font-size:16px;font-weight:700;color:var(--bk);cursor:pointer;transition:all .15s;
            display:flex;align-items:center;justify-content:center;font-family:var(--fm)}
        @media(hover:hover){.lap-btn:hover{border-color:var(--ac);color:var(--ac);background:var(--ac-bg)}}
        .lap-btn:active{transform:scale(.92)}
        .lap-btn:disabled{opacity:.3;cursor:default;transform:none}
        .lap-display{font-family:var(--fm);font-size:28px;font-weight:800;color:var(--bk);min-width:40px;text-align:center;letter-spacing:-.02em}
        .lap-display small{font-size:12px;font-weight:500;color:var(--soft);letter-spacing:0}
        .lap-desc{font-size:11px;color:var(--soft);margin-top:6px;line-height:1.4}

        /* ===== ã‚¯ã‚¤ã‚ºä¸­ã‚¿ã‚¤ãƒãƒ¼HUD ===== */
        .quiz-hud{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:8px}
        .quiz-timer{display:flex;align-items:center;gap:6px;font-family:var(--fm);font-size:13px;font-weight:600;
            color:var(--ac);padding:5px 12px;background:var(--ac-bg);border-radius:20px;border:1px solid rgba(108,99,255,.15)}
        .quiz-timer.warning{color:var(--red);background:var(--red-bg);border-color:rgba(255,71,87,.2);animation:timerPulse 1s infinite}
        .quiz-timer.expired{color:var(--red);background:var(--red-bg);border-color:var(--red)}
        @keyframes timerPulse{0%,100%{opacity:1}50%{opacity:.6}}
        .quiz-timer-icon{font-size:14px}
        .quiz-lap-badge{font-family:var(--fm);font-size:10px;font-weight:600;letter-spacing:.08em;
            padding:4px 10px;border-radius:16px;background:var(--ft);border:1px solid var(--ln);color:var(--mid)}
        .quiz-lap-badge .current-lap{color:var(--ac);font-weight:800}

        /* ===== å‘¨å›å®Œäº†ã‚µãƒãƒªãƒ¼ ===== */
        .lap-summary{background:var(--wh);border:1.5px solid var(--ln);border-radius:14px;padding:16px;margin-top:12px;
            box-shadow:var(--shadow-sm);text-align:center}
        .lap-summary-title{font-family:var(--fd);font-weight:800;font-size:18px;margin-bottom:4px}
        .lap-summary-sub{font-size:12px;color:var(--mid);margin-bottom:12px}
        .lap-summary-stats{display:flex;justify-content:center;gap:20px;margin-bottom:12px}
        .lap-summary-stat{text-align:center}
        .lap-summary-num{font-family:var(--fd);font-size:26px;font-weight:800}
        .lap-summary-label{font-family:var(--fm);font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:var(--soft)}
        .lap-perfect{font-size:32px;margin-bottom:8px}

        @media(max-width:640px){.shell{padding:0 16px}.header{padding:28px 0 8px}.header-logo{font-size:26px}.quiz-q{font-size:17px}.chat-ms{max-height:32vh}}
        ::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--ac2);border-radius:3px;opacity:.5}
    </style>
</head>
<body>

<div class="shell">
    <!-- MAIN SCREEN -->
    <div id="mainScreen" class="screen">
        <div class="header">
            <div class="header-logo" id="logoMain" onclick="goBackToMain()">Quick Quiz<span class="ai">AI</span></div>
            <div class="header-sub">JUKEN CAMP Ã— AI</div>
            <div class="header-line"></div>
        </div>
        <!-- æˆç¸¾ãƒˆãƒ©ãƒƒã‚«ãƒ¼ -->
        <div class="tracker-section">
            <div class="tracker-title">ğŸ“Š ãƒ‹ã‚¬ãƒ†å…‹æœãƒªã‚¹ãƒˆ TOP3</div>
            <div id="weakTopList"><p class="tracker-empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‚ˆã€‚å•é¡Œã‚’è§£ã„ã¦ã¿ã‚ˆã†ï¼</p></div>
            <div class="tracker-footer">
                <button class="tracker-reset-btn" onclick="if(confirm('æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){weakTracker={};saveTracker();renderWeakTop();}">ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="tracker-detail-btn" id="openStatsDetail">ğŸ“ˆ è©³ã—ãè¦‹ã‚‹</button>
            </div>
        </div>
        <div style="margin-top:14px">
            <div class="label">Select Subject</div>
            <div class="subj-grid">
                <button class="subj-item" data-subject="social"><div class="subj-icon"><span>ğŸŒ</span></div><div class="subj-text">ç¤¾ä¼š</div><div class="subj-arrow">â†’</div></button>
                <button class="subj-item" data-subject="science"><div class="subj-icon"><span>ğŸ”¬</span></div><div class="subj-text">ç†ç§‘</div><div class="subj-arrow">â†’</div></button>
                <button class="subj-item" data-subject="english"><div class="subj-icon"><span>ğŸ“–</span></div><div class="subj-text">è‹±èª</div><div class="subj-arrow">â†’</div></button>
            </div>
        </div>
        <div class="spacer"></div>
    </div>

    <!-- GAME SCREEN -->
    <div id="gameScreen" class="screen hidden">
        <div class="header">
            <div class="header-logo" id="logoGame" onclick="goBackFromGame()">Quick Quiz<span class="ai">AI</span></div>
            <div class="header-sub">JUKEN CAMP Ã— AI</div>
            <div class="header-line"></div>
        </div>
        <div id="currentCategory" style="font-family:var(--fd);font-weight:700;font-size:16px;margin-top:16px;letter-spacing:-.02em"></div>
        <div class="stats-row">
            <div class="stat-cell"><div class="stat-num" id="correctCount">0</div><div class="stat-label">Correct</div></div>
            <div class="stat-cell"><div class="stat-num" id="wrongCount">0</div><div class="stat-label">Wrong</div></div>
            <div class="stat-cell"><div class="stat-num" id="totalCount">0</div><div class="stat-label">Total</div></div>
        </div>
        <div class="label">Mode</div>
        <div class="mode-row">
            <button id="randomModeBtn" class="mode-btn mode-active">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
            <button id="sequentialModeBtn" class="mode-btn">ğŸ“‹ é †ç•ªé€šã‚Š</button>
        </div>

        <!-- ã‚¿ã‚¤ãƒãƒ¼è¨­å®š -->
        <div class="setting-card">
            <div class="setting-card-title">â±ï¸ ã‚¿ã‚¤ãƒãƒ¼</div>
            <div class="timer-grid">
                <div class="timer-input-wrap">
                    <input type="number" id="timerMin" class="timer-input" value="3" min="0" max="99" inputmode="numeric">
                    <div class="timer-input-label">min</div>
                </div>
                <div class="timer-colon">:</div>
                <div class="timer-input-wrap">
                    <input type="number" id="timerSec" class="timer-input" value="00" min="0" max="59" step="5" inputmode="numeric">
                    <div class="timer-input-label">sec</div>
                </div>
            </div>
            <div class="timer-presets">
                <button class="timer-preset" data-time="60">1åˆ†</button>
                <button class="timer-preset active" data-time="180">3åˆ†</button>
                <button class="timer-preset" data-time="300">5åˆ†</button>
                <button class="timer-preset" data-time="600">10åˆ†</button>
                <button class="timer-preset" data-time="0">âˆ ç„¡åˆ¶é™</button>
            </div>
            <div class="timer-toggle-row">
                <span class="timer-toggle-label">ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã§è‡ªå‹•çµ‚äº†</span>
                <label class="toggle-wrap">
                    <input type="checkbox" id="timerAutoEnd" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <!-- å‘¨å›ï¼ˆåå¾©ï¼‰è¨­å®š -->
        <div class="setting-card">
            <div class="setting-card-title">ğŸ”„ åå¾©ãƒ¢ãƒ¼ãƒ‰ <span style="font-size:10px;font-weight:400;color:var(--soft);margin-left:4px">â€” é–“é•ãˆãŸå•é¡Œã‚’ç¹°ã‚Šè¿”ã™</span></div>
            <div class="lap-row">
                <button class="lap-btn" id="lapMinus" disabled>âˆ’</button>
                <div class="lap-display" id="lapDisplay">1<small>å‘¨</small></div>
                <button class="lap-btn" id="lapPlus">+</button>
                <button class="timer-preset" id="lapInfinite" style="margin-left:auto">âˆ å…¨å•æ­£è§£ã¾ã§</button>
            </div>
            <div class="lap-desc" id="lapDesc">1å‘¨ã®ã¿ â€” å…¨å•ã‚’1å›é€šã—ã¦çµ‚äº†</div>
        </div>

        <button id="startQuizButton" class="btn btn-bk btn-full" style="margin-top:16px">ã‚¹ã‚¿ãƒ¼ãƒˆ â†’</button>
        <div class="spacer"></div>
    </div>
</div>

<!-- SUB-SUBJECT OVERLAYS -->
<div id="socialModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸŒ ç¤¾ä¼š</div><div class="label-desc">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„</div><div class="subj-grid">
    <button class="subj-item" data-category="geography"><div class="subj-icon">ğŸ—ºï¸</div><div class="subj-text">åœ°ç†</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="history"><div class="subj-icon">ğŸ›ï¸</div><div class="subj-text">æ­´å²</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="civics"><div class="subj-icon">âš–ï¸</div><div class="subj-text">å…¬æ°‘</div><div class="subj-arrow">â†’</div></button>
</div><div style="margin-top:24px"><button class="back-link" onclick="goBackToMain()">â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹</button></div></div></div>

<div id="scienceModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ”¬ ç†ç§‘</div><div class="label-desc">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„</div><div class="subj-grid">
    <button class="subj-item" data-category="chemistry"><div class="subj-icon">ğŸ§ª</div><div class="subj-text">åŒ–å­¦</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="biology"><div class="subj-icon">ğŸ§¬</div><div class="subj-text">ç”Ÿç‰©</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="physics"><div class="subj-icon">âš›ï¸</div><div class="subj-text">ç‰©ç†</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="earth"><div class="subj-icon">ğŸŒ</div><div class="subj-text">åœ°å­¦</div><div class="subj-arrow">â†’</div></button>
</div><div style="margin-top:24px"><button class="back-link" onclick="goBackToMain()">â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹</button></div></div></div>

<div id="englishModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ“– è‹±èª</div><div class="label-desc">åˆ†é‡ã‚’é¸ã‚“ã§ãã ã•ã„</div><div class="subj-grid">
    <button class="subj-item" data-category="english_words"><div class="subj-icon">ğŸ“</div><div class="subj-text">è‹±å˜èª</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="english_phrases"><div class="subj-icon">ğŸ’¬</div><div class="subj-text">è‹±ç†Ÿèª</div><div class="subj-arrow">â†’</div></button>
    <button class="subj-item" data-category="english_grammar"><div class="subj-icon">ğŸ“˜</div><div class="subj-text">èªå½¢å¤‰åŒ–</div><div class="subj-arrow">â†’</div></button>
</div><div style="margin-top:24px"><button class="back-link" onclick="goBackToMain()">â† æ•™ç§‘é¸æŠã«æˆ»ã‚‹</button></div></div></div>

<!-- CATEGORY SELECTION OVERLAYS -->
<div id="geographyModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ—ºï¸ åœ°ç†</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="geographyCategories"></div><div style="margin-top:24px;text-align:center"><button id="startGeographyQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToSocial()">â† ç¤¾ä¼šã«æˆ»ã‚‹</button></div></div></div>
<div id="historyModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ›ï¸ æ­´å²</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="historyCategories"></div><div style="margin-top:24px;text-align:center"><button id="startHistoryQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToSocial()">â† ç¤¾ä¼šã«æˆ»ã‚‹</button></div></div></div>
<div id="civicsModal" class="overlay"><div class="overlay-inner"><div class="label-lg">âš–ï¸ å…¬æ°‘</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="civicsCategories"></div><div style="margin-top:24px;text-align:center"><button id="startCivicsQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToSocial()">â† ç¤¾ä¼šã«æˆ»ã‚‹</button></div></div></div>
<div id="chemistryModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ§ª åŒ–å­¦</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="chemistryCategories"></div><div style="margin-top:24px;text-align:center"><button id="startChemistryQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="biologyModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ§¬ ç”Ÿç‰©</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="biologyCategories"></div><div style="margin-top:24px;text-align:center"><button id="startBiologyQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="physicsModal" class="overlay"><div class="overlay-inner"><div class="label-lg">âš›ï¸ ç‰©ç†</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="physicsCategories"></div><div style="margin-top:24px;text-align:center"><button id="startPhysicsQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="earthModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸŒ åœ°å­¦</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="earthCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEarthQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToScience()">â† ç†ç§‘ã«æˆ»ã‚‹</button></div></div></div>
<div id="englishWordsModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ“ è‹±å˜èª</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="englishWordsCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEnglishWordsQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToEnglish()">â† è‹±èªã«æˆ»ã‚‹</button></div></div></div>
<div id="englishPhrasesModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ’¬ è‹±ç†Ÿèª</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="englishPhrasesCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEnglishPhrasesQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToEnglish()">â† è‹±èªã«æˆ»ã‚‹</button></div></div></div>
<div id="englishGrammarModal" class="overlay"><div class="overlay-inner"><div class="label-lg">ğŸ“˜ èªå½¢å¤‰åŒ–</div><div class="label-desc">å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div><div class="cat-list" id="englishGrammarCategories"></div><div style="margin-top:24px;text-align:center"><button id="startEnglishGrammarQuiz" class="btn btn-bk" disabled>æ±ºå®š â†’</button></div><div style="margin-top:12px"><button class="back-link" onclick="goBackToEnglish()">â† è‹±èªã«æˆ»ã‚‹</button></div></div></div>

<!-- æˆç¸¾è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="stats-detail-ov" id="statsDetailOv">
    <div class="stats-detail-box">
        <div class="stats-detail-hd">
            <div class="stats-detail-title">ğŸ“ˆ æˆç¸¾ãƒ¬ãƒãƒ¼ãƒˆ</div>
            <button class="stats-detail-close" id="statsDetailClose">âœ•</button>
        </div>
        <div class="stats-detail-body">
            <div class="stats-summary-row" id="statsSummaryRow">
                <div class="stats-summary-card">
                    <div class="stats-summary-num" id="statsTotalAnswered">0</div>
                    <div class="stats-summary-label">Total</div>
                </div>
                <div class="stats-summary-card">
                    <div class="stats-summary-num" id="statsOverallRate" style="color:var(--ac)">â€”%</div>
                    <div class="stats-summary-label">æ­£ç­”ç‡</div>
                </div>
                <div class="stats-summary-card">
                    <div class="stats-summary-num" id="statsUnitCount">0</div>
                    <div class="stats-summary-label">å˜å…ƒæ•°</div>
                </div>
            </div>
            <div class="stats-detail-section">
                <div class="stats-detail-section-title">ğŸ”¥ ãƒ‹ã‚¬ãƒ† â€” ä¼¸ã³ã—ã‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <div class="stats-detail-list" id="statsWeakList">
                    <p class="tracker-empty">ãƒ‡ãƒ¼ã‚¿ãªã—</p>
                </div>
            </div>
            <div class="stats-detail-section">
                <div class="stats-detail-section-title">ğŸ’ª ãƒˆã‚¯ã‚¤ â€” è‡ªä¿¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
                <div class="stats-detail-list" id="statsStrongList">
                    <p class="tracker-empty">ãƒ‡ãƒ¼ã‚¿ãªã—</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QUIZ SCREEN -->
<div id="quizModal" class="quiz-ov">
    <div class="quiz-in">
        <div class="quiz-hud">
            <div class="quiz-timer" id="quizTimer" style="display:none">
                <span class="quiz-timer-icon">â±ï¸</span>
                <span id="quizTimerDisplay">3:00</span>
            </div>
            <div class="quiz-lap-badge" id="quizLapBadge" style="display:none">
                ROUND <span class="current-lap" id="quizCurrentLap">1</span> / <span id="quizMaxLap">1</span>
            </div>
        </div>
        <div class="quiz-cnt" id="quizCounter">QUESTION</div>
        <div class="quiz-q" id="quizQ"></div>
        <div class="quiz-opts" id="quizOptions"></div>
        <div class="quiz-res" id="quizResult"><span id="quizMsg"></span></div>
        <div class="quiz-acts">
            <button id="quizNext" class="btn btn-bk" disabled>æ¬¡ã®å•é¡Œ â†’</button>
            <button id="quizBack" class="btn btn-ol">æˆ»ã‚‹</button>
        </div>
    </div>
</div>


<!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒãƒƒãƒ— -->
<div class="quick-chips" id="quickChips"></div>

<!-- AIå…ˆç”Ÿ å›ºå®šãƒãƒ¼ -->
<div class="ai-bar" id="aiBar">
    <div class="ai-bar-label">âœ¨ AIå…ˆç”Ÿ</div>
    <input class="ai-bar-input" id="chatIn" placeholder="è³ªå•ã‚’å…¥åŠ›..." autocomplete="off">
    <button class="ai-bar-btn ai-bar-send" id="chatSd" disabled>â¤</button>
    <button class="ai-bar-btn ai-bar-icon" id="histBtn" title="å±¥æ­´">ğŸ“œ</button>
    <button class="ai-bar-btn ai-bar-icon" id="settingBtn" title="è¨­å®š">âš™ï¸</button>
</div>

<!-- è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="setting-ov" id="settingOv">
    <div class="setting-box">
        <div class="setting-title">âš™ï¸ AIå…ˆç”Ÿã®è¨­å®š
            <button class="setting-close" id="settingClose">âœ•</button>
        </div>
        <div class="mode-row">
            <span class="mode-label">å£èª¿</span>
            <div class="mode-btns">
                <button class="mode-btn" data-style="teacher">ğŸ§‘â€ğŸ« å…ˆç”Ÿ</button>
                <button class="mode-btn mode-active" data-style="friend">ğŸ¤™ å‹é”</button>
                <button class="mode-btn" data-style="exam">ğŸ“‹ è©¦é¨“å‘ã‘</button>
            </div>
        </div>
        <div class="mode-row">
            <span class="mode-label">æ·±ã•</span>
            <div class="mode-btns">
                <button class="mode-btn" data-depth="easy">ğŸŸ¢ ã‚„ã•ã—ã</button>
                <button class="mode-btn mode-active" data-depth="normal">ğŸŸ¡ ãµã¤ã†</button>
                <button class="mode-btn" data-depth="deep">ğŸ”´ æ·±ã</button>
            </div>
        </div>
        <div class="mode-row mode-row-toggle">
            <span class="mode-label">ä¸æ­£è§£ã§è‡ªå‹•åˆ†æ</span>
            <label class="toggle-wrap">
                <input type="checkbox" id="autoAnalyzeTog" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="mode-row" style="flex-direction:column;align-items:flex-start;gap:8px;margin-top:4px">
            <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
                <span class="mode-label">ãƒãƒ–ãƒ«è¡¨ç¤ºæ™‚é–“</span>
                <span style="font-family:var(--fm);font-size:11px;color:var(--ac);font-weight:600" id="bubbleDurLabel">10ç§’</span>
            </div>
            <input type="range" id="bubbleDurSlider" min="3" max="60" step="1" value="10"
                style="width:100%;accent-color:var(--ac);cursor:pointer;height:4px">
            <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
                <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:12px;color:var(--mid);font-family:var(--fb)">
                    <input type="checkbox" id="bubbleInfinite" style="accent-color:var(--ac);width:14px;height:14px">
                    ç„¡åˆ¶é™ï¼ˆæ¬¡ã®ãƒãƒ£ãƒƒãƒˆã¾ã§è¡¨ç¤ºï¼‰
                </label>
            </div>
        </div>
    </div>
</div>

<!-- å±¥æ­´ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="hist-ov" id="histOv">
    <div class="hist-box">
        <div class="hist-hd">
            <div class="hist-title">ğŸ’¬ ä¼šè©±å±¥æ­´</div>
            <button class="hist-close" id="histClose">âœ•</button>
        </div>
        <div class="hist-list" id="histList"></div>
        <div class="hist-chips" id="chips"></div>
    </div>
</div>

<!-- ãƒšãƒ¼ã‚¸ä½™ç™½ -->
<div class="ai-bar-spacer"></div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* ===== Timer & Lap Settings UI ===== */
(function(){
    /* --- Timer --- */
    const minEl=document.getElementById('timerMin');
    const secEl=document.getElementById('timerSec');
    const presets=document.querySelectorAll('.timer-preset[data-time]');
    const autoEndTog=document.getElementById('timerAutoEnd');

    function padZ(v){return String(v).padStart(2,'0')}
    function syncFromInputs(){
        let m=parseInt(minEl.value)||0, s=parseInt(secEl.value)||0;
        if(s>59){s=59;secEl.value=padZ(s)}
        if(m>99){m=99;minEl.value=m}
        const total=m*60+s;
        presets.forEach(p=>p.classList.toggle('active',parseInt(p.dataset.time)===total));
        updateQuizSettings();
    }
    minEl.addEventListener('input',syncFromInputs);
    secEl.addEventListener('input',syncFromInputs);
    minEl.addEventListener('blur',()=>{if(!minEl.value)minEl.value=0});
    secEl.addEventListener('blur',()=>{secEl.value=padZ(parseInt(secEl.value)||0)});

    presets.forEach(p=>{
        p.addEventListener('click',()=>{
            const t=parseInt(p.dataset.time);
            const m=Math.floor(t/60), s=t%60;
            minEl.value=m; secEl.value=padZ(s);
            presets.forEach(pp=>pp.classList.remove('active'));
            p.classList.add('active');
            updateQuizSettings();
        });
    });

    /* --- Lap / Repeat --- */
    const lapDisplay=document.getElementById('lapDisplay');
    const lapDesc=document.getElementById('lapDesc');
    const lapMinus=document.getElementById('lapMinus');
    const lapPlus=document.getElementById('lapPlus');
    const lapInfBtn=document.getElementById('lapInfinite');
    let lapCount=1, lapInfinite=false;

    function renderLap(){
        if(lapInfinite){
            lapDisplay.innerHTML='âˆ';
            lapDesc.textContent='å…¨å•æ­£è§£ã™ã‚‹ã¾ã§ä½•åº¦ã§ã‚‚ç¹°ã‚Šè¿”ã™';
            lapInfBtn.classList.add('active');
            lapMinus.disabled=true;
            lapPlus.disabled=true;
        }else{
            lapDisplay.innerHTML=lapCount+'<small>å‘¨</small>';
            lapMinus.disabled=lapCount<=1;
            lapPlus.disabled=lapCount>=10;
            lapInfBtn.classList.remove('active');
            const descs={
                1:'1å‘¨ã®ã¿ â€” å…¨å•ã‚’1å›é€šã—ã¦çµ‚äº†',
                2:'é–“é•ãˆãŸå•é¡Œã ã‘2å‘¨ç›®ã«å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
                3:'æœ€å¤§3å‘¨ â€” è‹¦æ‰‹ã‚’é›†ä¸­çš„ã«æ½°ã™ï¼'
            };
            lapDesc.textContent=descs[lapCount]||(lapCount+'å‘¨ã¾ã§åå¾© â€” å¼±ç‚¹ã‚’å¾¹åº•æ”»ç•¥ï¼');
        }
        updateQuizSettings();
    }
    lapMinus.addEventListener('click',()=>{if(lapCount>1){lapCount--;lapInfinite=false;renderLap()}});
    lapPlus.addEventListener('click',()=>{if(lapCount<10){lapCount++;lapInfinite=false;renderLap()}});
    lapInfBtn.addEventListener('click',()=>{lapInfinite=!lapInfinite;if(!lapInfinite&&lapCount<1)lapCount=1;renderLap()});
    renderLap();

    /* --- Expose to window for app.js --- */
    function updateQuizSettings(){
        const m=parseInt(minEl.value)||0, s=parseInt(secEl.value)||0;
        window.quizSettings=Object.assign(window.quizSettings||{},{
            timerSeconds:m*60+s,
            timerAutoEnd:autoEndTog.checked,
            lapCount:lapInfinite?Infinity:lapCount,
            lapInfinite:lapInfinite
        });
    }
    autoEndTog.addEventListener('change',updateQuizSettings);
    updateQuizSettings();

    /* --- Quiz Timer Runtime --- */
    let _timer=null, _remaining=0;
    window.startQuizTimer=function(){
        const cfg=window.quizSettings||{};
        const timerEl=document.getElementById('quizTimer');
        const dispEl=document.getElementById('quizTimerDisplay');
        clearInterval(_timer);
        if(!cfg.timerSeconds||cfg.timerSeconds<=0){timerEl.style.display='none';return}
        _remaining=cfg.timerSeconds;
        timerEl.style.display='flex';
        timerEl.classList.remove('warning','expired');
        function render(){
            const m=Math.floor(_remaining/60),s=_remaining%60;
            dispEl.textContent=m+':'+padZ(s);
            timerEl.classList.toggle('warning',_remaining<=30&&_remaining>0);
        }
        render();
        _timer=setInterval(()=>{
            _remaining--;
            if(_remaining<=0){
                _remaining=0;render();
                clearInterval(_timer);
                timerEl.classList.remove('warning');
                timerEl.classList.add('expired');
                dispEl.textContent="0:00 TIME UP!";
                if(cfg.timerAutoEnd&&typeof window.onQuizTimerEnd==='function'){
                    window.onQuizTimerEnd();
                }
            }else{render()}
        },1000);
    };
    window.stopQuizTimer=function(){clearInterval(_timer)};
    window.getQuizTimeRemaining=function(){return _remaining};

    /* --- Lap badge runtime --- */
    window.showLapBadge=function(current,max){
        const badge=document.getElementById('quizLapBadge');
        const maxLaps=window.quizSettings?.lapCount;
        if(!maxLaps||maxLaps<=1){badge.style.display='none';return}
        badge.style.display='';
        document.getElementById('quizCurrentLap').textContent=current||1;
        document.getElementById('quizMaxLap').textContent=maxLaps===Infinity?'âˆ':max||maxLaps;
    };
    window.hideLapBadge=function(){document.getElementById('quizLapBadge').style.display='none'};
})();

/* ===== Stats Detail Overlay ===== */
(function(){
    const ov=document.getElementById('statsDetailOv');
    const openBtn=document.getElementById('openStatsDetail');
    const closeBtn=document.getElementById('statsDetailClose');

    openBtn.addEventListener('click',()=>{
        renderStatsDetail();
        ov.classList.add('show');
    });
    closeBtn.addEventListener('click',()=>ov.classList.remove('show'));
    ov.addEventListener('click',(e)=>{if(e.target===ov)ov.classList.remove('show')});

    function getTrackerData(){
        try{return JSON.parse(localStorage.getItem('weakTracker'))||{}}catch(e){return{}}
    }

    function sortByRate(data,ascending){
        return Object.entries(data).map(([key,v])=>{
            const total=(v.correct||0)+(v.wrong||0);
            const rate=total>0?((v.correct||0)/total*100):null;
            return{key,name:v.name||key,correct:v.correct||0,wrong:v.wrong||0,total,rate};
        }).filter(d=>d.total>0).sort((a,b)=>{
            if(ascending) return (a.rate??999)-(b.rate??999);
            return (b.rate??-1)-(a.rate??-1);
        });
    }

    function makeTrackerItem(d,type,rank){
        const pct=d.rate!==null?Math.round(d.rate):'â€”';
        const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
        const rankIcon=rank<3?medals[rank]:(rank+1+'.');
        const barClass=type==='weak'?'weak':'strong';
        const pctClass=type==='weak'?'weak':'strong';
        const div=document.createElement('div');
        div.className='tracker-item';
        div.setAttribute('data-unit-key',d.key);
        div.innerHTML=
            '<div class="tracker-rank">'+rankIcon+'</div>'+
            '<div class="tracker-info">'+
                '<div class="tracker-name">'+d.name+'</div>'+
                '<div class="tracker-bar-wrap"><div class="tracker-bar '+barClass+'" style="width:'+(pct==='â€”'?0:pct)+'%"></div></div>'+
            '</div>'+
            '<div class="tracker-pct '+pctClass+'">'+pct+'%<br><small>'+d.correct+'/'+d.total+'</small></div>'+
            '<div class="tracker-arrow">â†’</div>';
        div.addEventListener('click',()=>{
            if(typeof window.startQuizFromTracker==='function'){
                window.startQuizFromTracker(d.key);
                ov.classList.remove('show');
            }
        });
        return div;
    }

    function renderStatsDetail(){
        const data=getTrackerData();
        const weakList=document.getElementById('statsWeakList');
        const strongList=document.getElementById('statsStrongList');
        const weak=sortByRate(data,true);
        const strong=sortByRate(data,false);

        // Summary
        let totalQ=0,totalC=0,units=0;
        Object.values(data).forEach(v=>{
            const t=(v.correct||0)+(v.wrong||0);
            if(t>0){totalQ+=t;totalC+=(v.correct||0);units++}
        });
        document.getElementById('statsTotalAnswered').textContent=totalQ;
        document.getElementById('statsOverallRate').textContent=totalQ>0?Math.round(totalC/totalQ*100)+'%':'â€”%';
        document.getElementById('statsUnitCount').textContent=units;

        // Weak list
        weakList.innerHTML='';
        if(weak.length===0){weakList.innerHTML='<p class="tracker-empty">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
        }else{weak.forEach((d,i)=>weakList.appendChild(makeTrackerItem(d,'weak',i)))}

        // Strong list
        strongList.innerHTML='';
        if(strong.length===0){strongList.innerHTML='<p class="tracker-empty">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
        }else{strong.forEach((d,i)=>strongList.appendChild(makeTrackerItem(d,'strong',i)))}
    }

    /* --- app.js now handles renderWeakTop with new tracker classes natively --- */
})();
</script>
<script src="app.js"></script>
</body>
</html>
